# RoleMirror: æ¸¸æˆ NPC å¯¹è¯è‡ªåŠ¨åŒ–è¯„æµ‹ç³»ç»Ÿ

RoleMirror æ˜¯ä¸€ä¸ªåŸºäº LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰çš„è‡ªåŠ¨åŒ–è¯„æµ‹æ¡†æ¶ï¼Œæ—¨åœ¨è¯„ä¼°æ¸¸æˆ NPCï¼ˆéç©å®¶è§’è‰²ï¼‰çš„å¯¹è¯è´¨é‡ã€è§’è‰²ä¸€è‡´æ€§å’Œäº’åŠ¨ä½“éªŒã€‚

é€šè¿‡ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„ LLM Agent â€”â€” ä¸€ä¸ªæ‰®æ¼” **NPC**ï¼Œå¦ä¸€ä¸ªæ‰®æ¼” **æ¨¡æ‹Ÿç©å®¶ï¼ˆPlayer Simulatorï¼‰** â€”â€” è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œå¹¶ç”±ç¬¬ä¸‰ä¸ª **Grader Agent** å¯¹å¯¹è¯è®°å½•è¿›è¡Œè¯„åˆ†å’Œè¯æ®æå–ã€‚

## æ ¸å¿ƒç‰¹æ€§

*   **è‡ªåŠ¨åŒ–åŒ Agent æ¨¡æ‹Ÿ**ï¼š
    *   **Mock NPC**ï¼šåŸºäºè®¾å®šçš„äººè®¾ï¼ˆPersonaï¼‰è¿›è¡Œè§’è‰²æ‰®æ¼”ï¼Œå— Token é™åˆ¶ä»¥æ¨¡æ‹ŸçœŸå®æ¸¸æˆå¯¹è¯çš„ç®€æ´æ€§ã€‚
    *   **Player Simulator**ï¼šåŸºäºç‰¹å®šçš„æµ‹è¯•ç›®æ ‡ï¼ˆå¦‚â€œæ¿€æ€’NPCâ€ã€â€œå°è¯•ç ä»·â€ï¼‰é©±åŠ¨å¯¹è¯å‘å±•ã€‚
*   **Model-Graded Evaluationï¼ˆæ¨¡å‹çº§è¯„æµ‹ï¼‰**ï¼š
    *   åˆ©ç”¨ LLM ä½œä¸ºè£åˆ¤ï¼Œå¯¹å¯¹è¯è¿›è¡Œå¤šç»´åº¦æ‰“åˆ†ï¼ˆ1-5åˆ†ï¼‰ã€‚
    *   è‡ªåŠ¨æå–å¯¹è¯ä¸­çš„â€œè¯æ®â€ç‰‡æ®µæ¥æ”¯æŒè¯„åˆ†ç†ç”±ã€‚
    *   æ”¯æŒè‡ªå®šä¹‰è¯„æµ‹æ ‡å‡†ï¼ˆå¦‚ï¼šè§’è‰²ä¸€è‡´æ€§ã€äº’åŠ¨æµç•…åº¦ï¼‰ã€‚
*   **å®Œå…¨ä¸­æ–‡åŒ–**ï¼š
    *   æ”¯æŒä¸­æ–‡ NPC äººè®¾å’Œå¯¹è¯ã€‚
    *   è¯„æµ‹æŠ¥å‘Šï¼ˆç†ç”±ã€è¯æ®ï¼‰å…¨ä¸­æ–‡è¾“å‡ºã€‚
*   **é…ç½®çµæ´»**ï¼š
    *   NPC å®šä¹‰ä¸æµ‹è¯•åœºæ™¯åˆ†ç¦»ï¼Œæ”¯æŒå¤ç”¨ã€‚
    *   æ”¯æŒé€šè¿‡ CLI è¿è¡Œç‰¹å®šåœºæ™¯ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„ (System Architecture)

RoleMirror é‡‡ç”¨äº†æ¨¡å—åŒ–çš„ **å¤šæ™ºèƒ½ä½“åä½œ (Multi-Agent Collaboration)** æ¶æ„ã€‚ç³»ç»Ÿä¸»è¦ç”±ä¸‰ä¸ªæ ¸å¿ƒ Agent å’Œä¸€ä¸ªä¸­å¤®æ§åˆ¶å™¨ç»„æˆã€‚

```mermaid
graph TD
    subgraph Configuration [é…ç½®å±‚]
        Config_NPC[npcs.json]
        Config_Scenario[scenarios.json]
        Config_Grader[grader_config.json]
    end

    subgraph Core_Engine [æ ¸å¿ƒå¼•æ“]
        Runner["Test Runner<br>(è¯„æµ‹æ§åˆ¶å™¨)"]
    end

    subgraph Agents [æ™ºèƒ½ä½“å±‚]
        Player["Player Simulator Agent<br>(æ¨¡æ‹Ÿç©å®¶)"]
        NPC["Mock NPC Agent<br>(è¢«æµ‹å¯¹è±¡)"]
        Grader["Grader Agent<br>(è£åˆ¤å®˜)"]
    end

    subgraph Output [è¾“å‡ºå±‚]
        Report["JSON Report<br>(è¯„æµ‹æŠ¥å‘Š)"]
    end

    %% Data Flow
    Config_NPC --> Runner
    Config_Scenario --> Runner
    Config_Grader --> Grader

    Runner -- 1. åˆå§‹åŒ–å¯¹è¯ --> Player
    Player -- 2. å‘é€æ¶ˆæ¯ --> NPC
    NPC -- 3. å›å¤/è°ƒç”¨å·¥å…· --> Runner
    Runner -- 4. è½¬å‘å›å¤ --> Player
    
    Runner -- 5. æäº¤å¯¹è¯æ—¥å¿— --> Grader
    Grader -- 6. è¿”å›è¯„åˆ†ä¸è¯æ® --> Runner
    Runner --> Report
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

1.  **Test Runner (æ§åˆ¶å™¨)**:
    *   ç³»ç»Ÿçš„â€œå¤§è„‘â€ã€‚è´Ÿè´£åŠ è½½é…ç½®ã€åˆå§‹åŒ– Agentã€ç®¡ç†å¯¹è¯è½®æ¬¡ã€å¤„ç†å·¥å…·è°ƒç”¨æ‰§è¡Œï¼Œå¹¶æœ€ç»ˆåè°ƒæ‰“åˆ†æµç¨‹ã€‚
    *   å®ƒç¡®ä¿äº†æµ‹è¯•æµç¨‹çš„æ ‡å‡†åŒ–å’Œè‡ªåŠ¨åŒ–ã€‚

2.  **Player Simulator (æ¨¡æ‹Ÿç©å®¶)**:
    *   **è§’è‰²**: æ”»å‡»è€… / æµ‹è¯•å‘˜ã€‚
    *   **èŒè´£**: æ ¹æ® `scenarios.json` ä¸­å®šä¹‰çš„ `goal`ï¼ˆç›®æ ‡ï¼‰å’Œ `context`ï¼ˆèƒŒæ™¯ï¼‰ï¼ŒåŠ¨æ€ç”Ÿæˆé€¼çœŸçš„ç©å®¶å¯¹è¯ã€‚å®ƒä¸ä»…æ˜¯ç®€å•çš„å‘é—®æœºï¼Œè¿˜èƒ½æ ¹æ® NPC çš„ååº”è°ƒæ•´ç­–ç•¥ï¼ˆä¾‹å¦‚ï¼šå¦‚æœ NPC æ‹’ç»ï¼Œå®ƒå¯èƒ½ä¼šå°è¯•å¨èƒæˆ–åˆ©è¯±ï¼‰ã€‚

3.  **Mock NPC (è¢«æµ‹å¯¹è±¡)**:
    *   **è§’è‰²**: é˜²å®ˆè€… / è¢«æµ‹ç³»ç»Ÿã€‚
    *   **èŒè´£**: æ ¹æ® `npcs.json` ä¸­çš„ `persona`ï¼ˆäººè®¾ï¼‰è¿›è¡Œå›å¤ã€‚å®ƒé›†æˆäº† Tool Calling èƒ½åŠ›ï¼Œå¯ä»¥åœ¨å¯¹è¯ä¸­è°ƒç”¨æ³¨å†Œçš„ Python å‡½æ•°ï¼ˆå¦‚ `generate_gift_code`ï¼‰ã€‚

4.  **Grader (è£åˆ¤å®˜)**:
    *   **è§’è‰²**: è¯„ä¼°è€…ã€‚
    *   **èŒè´£**: åŸºäº `grader_config.json` ä¸­çš„å¤šç»´åº¦æ ‡å‡†ï¼ˆå¦‚â€œè§’è‰²ä¸€è‡´æ€§â€ã€â€œå·¥å…·ä½¿ç”¨åˆç†æ€§â€ï¼‰ï¼Œåˆ©ç”¨ LLM çš„æ¨ç†èƒ½åŠ›å¯¹å®Œæ•´çš„å¯¹è¯æ—¥å¿—è¿›è¡Œæ‰“åˆ† (1-5åˆ†)ï¼Œå¹¶æå–åŸæ–‡è¯æ® (Evidence)ã€‚

### å·¥ä½œæµç¨‹

1.  **åŠ è½½**: ç³»ç»Ÿè¯»å– NPC å’Œ åœºæ™¯é…ç½®ã€‚
2.  **äº¤äº’**: Runner å¯åŠ¨å¯¹è¯å¾ªç¯ï¼ŒPlayer å’Œ NPC äº¤æ›¿å‘è¨€ã€‚å¦‚æœ NPC å‘èµ·å·¥å…·è°ƒç”¨ï¼ŒRunner ä¼šæ‹¦æˆªå¹¶æ‰§è¡Œä»£ç ï¼Œå°†ç»“æœè¿”å›ç»™ NPCã€‚
3.  **è¯„æµ‹**: å¯¹è¯ç»“æŸåï¼Œå®Œæ•´çš„äº¤äº’æ—¥å¿—è¢«é€å¾€ Graderã€‚
4.  **æŠ¥å‘Š**: ç”ŸæˆåŒ…å«è¯„åˆ†ã€ç†ç”±ã€è¯æ®å’Œå…ƒæ•°æ®ï¼ˆå»¶è¿Ÿã€Tokenæ¶ˆè€—ï¼‰çš„è¯¦ç»† JSON æŠ¥å‘Šã€‚

## é¡¹ç›®ç»“æ„

RoleMirror é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–åˆ†å±‚æ¶æ„ï¼Œä»£ç ç»„ç»‡æ¸…æ™°ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤ã€‚

### ç›®å½•å±‚çº§æ¦‚è§ˆ

```
RoleMirror/
â”œâ”€â”€ src/                        # æ ¸å¿ƒæºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ agents/                 # æ™ºèƒ½ä½“å®ç°å±‚
â”‚   â”‚   â”œâ”€â”€ base.py             # Agent æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ npc.py              # Mock NPC Agent (è¢«æµ‹å¯¹è±¡å®ç°)
â”‚   â”‚   â””â”€â”€ simulator.py        # Player Simulator Agent (ç©å®¶æ¨¡æ‹Ÿå™¨)
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒé€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ runner.py           # è¯„æµ‹è¿è¡Œæ§åˆ¶å™¨ (Test Runner)
â”‚   â”‚   â”œâ”€â”€ grader.py           # è‡ªåŠ¨è¯„åˆ†å¼•æ“ (LLM-as-a-Judge)
â”‚   â”‚   â”œâ”€â”€ metrics.py          # ç»Ÿè®¡æŒ‡æ ‡è®¡ç®— (Pass@K, Pass^K ç­‰)
â”‚   â”‚   â”œâ”€â”€ log_evaluator.py    # ç¦»çº¿æ—¥å¿—åˆ†æå™¨
â”‚   â”‚   â””â”€â”€ safety.py           # å®‰å…¨æ£€æµ‹æ¨¡å— (æ•æ„Ÿè¯è¿‡æ»¤)
â”‚   â”œâ”€â”€ data/                   # é…ç½®ä¸æ•°æ®èµ„æºå±‚
â”‚   â”‚   â”œâ”€â”€ npcs.json           # NPC è§’è‰²é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ scenarios.json      # æµ‹è¯•åœºæ™¯é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ grader_config.json  # è¯„åˆ†ç»´åº¦ä¸è£åˆ¤æ¨¡å‹é…ç½®
â”‚   â”‚   â”œâ”€â”€ blocked_words.json  # å®‰å…¨è¿‡æ»¤æ•æ„Ÿè¯åº“
â”‚   â”‚   â””â”€â”€ external_logs_sample.json # å¤–éƒ¨æ—¥å¿—å¯¼å…¥ç¤ºä¾‹
â”‚   â””â”€â”€ llm_client.py           # LLM API å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ tests/                      # å•å…ƒæµ‹è¯•ç›®å½•
â”‚   â””â”€â”€ test_metrics.py         # æŒ‡æ ‡è®¡ç®—æ¨¡å—æµ‹è¯•
â”œâ”€â”€ reports/                    # è¯„æµ‹æŠ¥å‘Šè¾“å‡ºç›®å½• (è‡ªåŠ¨ç”Ÿæˆ)
â”œâ”€â”€ report_analysis/            # å¯è§†åŒ–åˆ†æç»“æœç›®å½• (è‡ªåŠ¨ç”Ÿæˆ)
â”œâ”€â”€ main.py                     # [å…¥å£] åœ¨çº¿äº¤äº’è¯„æµ‹å¯åŠ¨è„šæœ¬
â”œâ”€â”€ evaluate_logs.py            # [å…¥å£] ç¦»çº¿æ—¥å¿—è¯„æµ‹å¯åŠ¨è„šæœ¬
â”œâ”€â”€ analyze_report.py           # [å·¥å…·] è¯„æµ‹æŠ¥å‘Šå¯è§†åŒ–åˆ†æè„šæœ¬
â”œâ”€â”€ requirements.txt            # Python é¡¹ç›®ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
â”œâ”€â”€ .gitignore                  # Git ç‰ˆæœ¬æ§åˆ¶å¿½ç•¥é…ç½®
â””â”€â”€ README.md                   # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

### å…³é”®ç›®å½•ä¸æ–‡ä»¶è¯´æ˜

#### 1. `src/` (æºä»£ç æ ¸å¿ƒ)
è¿™æ˜¯é¡¹ç›®çš„ä¸»è¦é€»è¾‘æ‰€åœ¨ï¼Œåˆ†ä¸ºä¸‰ä¸ªå­æ¨¡å—ï¼š
*   **`agents/`**: å­˜æ”¾æ‰€æœ‰æ™ºèƒ½ä½“çš„å®ç°ä»£ç ã€‚`npc.py` å®šä¹‰äº†è¢«æµ‹ NPC çš„è¡Œä¸ºé€»è¾‘å’Œå·¥å…·è°ƒç”¨èƒ½åŠ›ï¼›`simulator.py` å®šä¹‰äº†ç”¨äºæµ‹è¯• NPC çš„æ¨¡æ‹Ÿç©å®¶è¡Œä¸ºã€‚
*   **`core/`**: åŒ…å«ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ã€‚`runner.py` æ˜¯æ•´ä¸ªæµ‹è¯•æµç¨‹çš„è°ƒåº¦ä¸­å¿ƒï¼›`grader.py` è´Ÿè´£è°ƒç”¨ LLM å¯¹å¯¹è¯è¿›è¡Œæ‰“åˆ†ï¼›`metrics.py` æä¾›äº† Pass@K ç­‰é«˜çº§ç»Ÿè®¡æŒ‡æ ‡çš„è®¡ç®—é€»è¾‘ï¼›`safety.py` ç”¨äºå¯¹è¯å†…å®¹çš„å®‰å…¨è¿‡æ»¤ã€‚
*   **`data/`**: å­˜æ”¾æ‰€æœ‰ JSON æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚é€šè¿‡ä¿®æ”¹è¿™é‡Œçš„ JSON æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹æ–°å¢ NPC (`npcs.json`)ã€è®¾è®¡æ–°æµ‹è¯•åœºæ™¯ (`scenarios.json`) æˆ–è°ƒæ•´è¯„åˆ†æ ‡å‡† (`grader_config.json`)ã€‚

#### 2. å…¥å£è„šæœ¬
*   **`main.py`**: è¿›è¡Œåœ¨çº¿è¯„æµ‹çš„ä¸»å…¥å£ã€‚å®ƒä¼šæ ¹æ®é…ç½®å¯åŠ¨ Player å’Œ NPC çš„äº¤äº’ï¼Œå¹¶å®æ—¶ç”Ÿæˆè¯„æµ‹æŠ¥å‘Šã€‚
*   **`evaluate_logs.py`**: ç”¨äºå¯¹å·²æœ‰çš„å¯¹è¯æ—¥å¿—è¿›è¡Œâ€œäº‹åè¯¸è‘›äº®â€å¼çš„è¯„æµ‹ã€‚é€‚ç”¨äºåˆ†æå†å²æ•°æ®æˆ–å¤–éƒ¨å¯¼å…¥çš„æ—¥å¿—ã€‚

#### 3. å·¥å…·ä¸åˆ†æ
*   **`analyze_report.py`**: ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åˆ†æå·¥å…·ã€‚è¯»å–ç”Ÿæˆçš„ JSON æŠ¥å‘Šï¼Œè¾“å‡ºå›¾è¡¨ï¼ˆå¦‚è¯„åˆ†åˆ†å¸ƒå›¾ã€å»¶è¿Ÿåˆ†æå›¾ï¼‰å’Œ Markdown æ ¼å¼çš„æ±‡æ€»æŠ¥å‘Šï¼Œå¸®åŠ©ç”¨æˆ·ç›´è§‚ç†è§£è¯„æµ‹ç»“æœã€‚

#### 4. æµ‹è¯•ä¸æ„å»º
*   **`tests/`**: åŒ…å«é¡¹ç›®çš„å•å…ƒæµ‹è¯•ä»£ç ï¼Œç¡®ä¿æ ¸å¿ƒç®—æ³•ï¼ˆå¦‚æŒ‡æ ‡è®¡ç®—ï¼‰çš„å‡†ç¡®æ€§ã€‚
*   **`requirements.txt`**: åˆ—å‡ºäº†é¡¹ç›®è¿è¡Œæ‰€éœ€çš„ Python åº“ï¼ˆå¦‚ `openai`, `dashscope`, `pandas`, `matplotlib` ç­‰ï¼‰ã€‚

### ç‰¹æ®Šè¯´æ˜
*   **æŠ¥å‘Šè¾“å‡º**: è¿è¡Œ `main.py` åï¼Œç”Ÿæˆçš„ JSON æŠ¥å‘Šä¼šé»˜è®¤ä¿å­˜åœ¨ `reports/` ç›®å½•ä¸‹ã€‚è¿è¡Œ `analyze_report.py` åï¼Œå¯è§†åŒ–ç»“æœä¼šä¿å­˜åœ¨ `report_analysis/` ä¸‹å¯¹åº”çš„å­ç›®å½•ä¸­ã€‚
*   **é…ç½®é©±åŠ¨**: æœ¬é¡¹ç›®éµå¾ªâ€œé…ç½®å³ä»£ç â€çš„è®¾è®¡ç†å¿µï¼Œå¤§éƒ¨åˆ†æ‰©å±•åŠŸèƒ½ï¼ˆæ–°å¢è§’è‰²ã€åœºæ™¯ï¼‰ä»…éœ€ä¿®æ”¹ `src/data/` ä¸‹çš„ JSON æ–‡ä»¶å³å¯ç”Ÿæ•ˆã€‚

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å®‰è£…äº† Python 3.10+ã€‚

```bash
# å…‹éš†ä»“åº“ï¼ˆç•¥ï¼‰

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½® API Key

å¤åˆ¶ `.env.example` ä¸º `.env`ï¼Œå¹¶å¡«å…¥ä½ çš„ API Keyï¼ˆæœ¬é¡¹ç›®é»˜è®¤ä½¿ç”¨é˜¿é‡Œäº‘ DashScope çš„ `qwen-flash` æ¨¡å‹ï¼Œå…¼å®¹ OpenAI SDKï¼‰ã€‚

```ini
# .env
DASHSCOPE_API_KEY=your_dashscope_api_key_here
LLM_MODEL=qwen-flash
```

### 3. è¿è¡Œè¯„æµ‹

#### åœ¨çº¿äº¤äº’è¯„æµ‹
ç›´æ¥è¿è¡Œ `main.py` å³å¯å¯åŠ¨æ‰€æœ‰å®šä¹‰çš„æµ‹è¯•åœºæ™¯ï¼ˆé»˜è®¤ä¼šè‡ªåŠ¨ç”Ÿæˆ NPC x åœºæ™¯ çš„å…¨ç»„åˆçŸ©é˜µæµ‹è¯•ï¼‰ï¼š

```bash
# é»˜è®¤ä¸²è¡Œè¿è¡Œ
python main.py

# æŒ‡å®šå¹¶å‘æ•°ï¼ˆä¾‹å¦‚ 5 ä¸ªçº¿ç¨‹å¹¶è¡Œï¼‰
python main.py --concurrency 5

# æŒ‡å®šæ¯ä¸ªåœºæ™¯çš„é‡å¤æµ‹è¯•æ¬¡æ•°ï¼ˆä¾‹å¦‚æ¯ä¸ªç»„åˆæµ‹ 3 éï¼‰
python main.py --concurrency 5 --repeat 3

# æŒ‡å®šæµ‹è¯•ç‰¹å®šçš„ NPCï¼ˆä¾‹å¦‚åªæµ‹ npc_elaraï¼‰
python main.py --npc npc_elara

# æŒ‡å®šæµ‹è¯•ç‰¹å®šçš„åœºæ™¯ï¼ˆä¾‹å¦‚åªæµ‹ scenario_bargainï¼‰
python main.py --scenario scenario_bargain
```

ç¨‹åºè¿è¡Œç»“æŸåï¼Œä¼šåœ¨ `reports/` ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªåŒ…å«æ—¶é—´æˆ³çš„ JSON æŠ¥å‘Šæ–‡ä»¶ã€‚

#### ç¦»çº¿æ—¥å¿—è¯„æµ‹
å¦‚æœä½ å·²ç»æœ‰ç°æˆçš„å¯¹è¯æ—¥å¿—ï¼ˆJSONæ ¼å¼ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `evaluate_logs.py` è¿›è¡Œçº¯è¯„æµ‹ï¼š

```bash
python evaluate_logs.py path/to/your/logs.json --output reports/ --concurrency 3
```

## è¯„æµ‹æŒ‡æ ‡ (Evaluation Metrics)

æŠ¥å‘Šä¸­åŒ…å«ä»¥ä¸‹æ ¸å¿ƒæŒ‡æ ‡ï¼š

### 1. åŸºç¡€æŒ‡æ ‡
*   **ç»´åº¦è¯„åˆ† (1-5)**ï¼šç”±è£åˆ¤æ¨¡å‹æ ¹æ®é…ç½®çš„æ ‡å‡†æ‰“åˆ†ã€‚
*   **æ€§èƒ½æŒ‡æ ‡**ï¼š
    *   `avg_latency_seconds`: NPC å¹³å‡å“åº”æ—¶é—´ã€‚
    *   `avg_tokens_per_turn`: NPC å¹³å‡å›å¤ Token æ•°ã€‚
    *   `total_tokens`: æ€» Token æ¶ˆè€—ã€‚

### 2. è¿›é˜¶æŒ‡æ ‡ï¼šPass@K ä¸ Pass^K

ä¸ºäº†è¯„ä¼° NPC çš„è¡Œä¸ºç¨³å®šæ€§å’Œä»»åŠ¡è¾¾æˆç‡ï¼ŒRoleMirror å¼•å…¥äº†ä»£ç ç”Ÿæˆè¯„æµ‹ä¸­å¸¸ç”¨çš„ Pass@K å’Œ Pass^K æŒ‡æ ‡ï¼š

1.  **Pass@K** (kæ¬¡ç”Ÿæˆä¸­è‡³å°‘ä¸€æ¬¡é€šè¿‡çš„æ¦‚ç‡):
    *   **å®šä¹‰**: ç»™å®šä¸€ä¸ªæµ‹è¯•åœºæ™¯ï¼Œè¿è¡Œ $k$ æ¬¡ï¼Œå¦‚æœå…¶ä¸­è‡³å°‘æœ‰ä¸€æ¬¡é€šè¿‡ï¼ˆpassï¼‰ï¼Œåˆ™è®¤ä¸ºè¯¥åœºæ™¯åœ¨ @k æ°´å¹³ä¸Šé€šè¿‡ã€‚é€šå¸¸ç”¨äºè¯„ä¼°â€œå°è¯•å¤šæ¬¡èƒ½æˆåŠŸçš„æ¦‚ç‡â€ã€‚
    *   **è®¡ç®—å…¬å¼** (æ— åä¼°è®¡):
        $$ \text{pass@k} = 1 - \frac{\binom{n-c}{k}}{\binom{n}{k}} $$
        å…¶ä¸­ $n$ ä¸ºæ€»é‡‡æ ·æ¬¡æ•°ï¼Œ$c$ ä¸ºé€šè¿‡çš„æ¬¡æ•°ã€‚

2.  **Pass^K** (kæ¬¡ç”Ÿæˆå…¨éƒ¨é€šè¿‡çš„æ¦‚ç‡):
    *   **å®šä¹‰**: ç»™å®šä¸€ä¸ªæµ‹è¯•åœºæ™¯ï¼Œè¿ç»­è¿è¡Œ $k$ æ¬¡ï¼Œè¦æ±‚è¿™ $k$ æ¬¡ **å…¨éƒ¨** é€šè¿‡æ‰ç®—æˆåŠŸã€‚ç”¨äºè¯„ä¼°â€œè¡Œä¸ºçš„ä¸€è‡´æ€§å’Œé«˜å¯é æ€§â€ã€‚
    *   **è®¡ç®—å…¬å¼**:
        $$ \text{pass^k} = \frac{\binom{c}{k}}{\binom{n}{k}} $$

**å¦‚ä½•ä½¿ç”¨**:
*   åœ¨è¿è¡Œ `main.py` æ—¶ï¼Œé€šè¿‡å¢åŠ  `--repeat` å‚æ•°ï¼ˆå»ºè®® >= 3ï¼‰æ¥å¯ç”¨è¿™äº›æŒ‡æ ‡çš„è®¡ç®—ã€‚
*   `analyze_report.py` ä¼šè‡ªåŠ¨ç”Ÿæˆè¿™ä¸¤ä¸ªæŒ‡æ ‡çš„å¯¹æ¯”æŸ±çŠ¶å›¾ã€‚

## ç»“æœåˆ†æä¸å¯è§†åŒ–

RoleMirror æä¾›äº†ä¸€ä¸ªåˆ†æè„šæœ¬ï¼Œå¯ä»¥å°†ç”Ÿæˆçš„ JSON è¯„æµ‹æŠ¥å‘Šè½¬æ¢ä¸ºå¯è§†åŒ–å›¾è¡¨å’Œ Markdown æŠ¥å‘Šã€‚

```bash
# è¿è¡Œåˆ†æè„šæœ¬
# é»˜è®¤ä¼šåœ¨ report_analysis/ ç›®å½•ä¸‹åˆ›å»ºä¸æŠ¥å‘ŠåŒåçš„æ–‡ä»¶å¤¹
python analyze_report.py reports/your_report.json
```

è„šæœ¬å°†åœ¨è¾“å‡ºç›®å½•ï¼ˆä¾‹å¦‚ `report_analysis/your_report/`ï¼‰ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š
*   `analysis_report.md`: åŒ…å«ç»Ÿè®¡æ•°æ®å’Œå›¾è¡¨å¼•ç”¨çš„åˆ†ææŠ¥å‘Šã€‚
*   `processed_data.csv`: å¤„ç†åçš„æ±‡æ€»æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰ã€‚
*   `score_distribution.png`: å„è¯„æµ‹ç»´åº¦çš„åˆ†æ•°åˆ†å¸ƒç®±çº¿å›¾ã€‚
*   `npc_performance.png`: å„ NPC çš„å¹³å‡å¾—åˆ†æ’è¡Œã€‚
*   `latency_vs_score.png`: å“åº”å»¶è¿Ÿä¸è¯„åˆ†çš„ç›¸å…³æ€§æ•£ç‚¹å›¾ã€‚

## ğŸš€ æ‰©å±•æŒ‡å—

RoleMirror çš„è®¾è®¡é«˜åº¦æ¨¡å—åŒ–ï¼Œä½ å¯ä»¥è½»æ¾åœ°æ‰©å±• NPCã€åœºæ™¯å’Œå·¥å…·ã€‚

### 1. æ–°å¢ NPC (Add NPC)

åªéœ€ä¿®æ”¹ `src/data/npcs.json` æ–‡ä»¶å³å¯æ·»åŠ æ–°çš„ NPCã€‚æ— éœ€ç¼–å†™ä»£ç ã€‚

**ç¤ºä¾‹**ï¼šæ·»åŠ ä¸€ä¸ªâ€œç¥ç§˜å•†äººâ€
```json
{
  "id": "npc_mystic_merchant",
  "name": "ç¥ç§˜å•†äºº",
  "persona": "ä¸€ä½æ¸¸èµ°äºå„ä¸ªä½é¢çš„ç¥ç§˜å•†äººã€‚ä»–åªå¯¹ç¨€æœ‰çš„çŸ¥è¯†å’Œå¤ä»£é—ç‰©æ„Ÿå…´è¶£ï¼Œè¯´è¯æ€»æ˜¯å¸¦ç€ä¸€ç§è¯±æƒ‘å’Œå±é™©çš„è¯­æ°”ã€‚ä»–æ‰‹é‡Œæœ‰ä¸€æœ¬çŸ¥æ™“ä¸‡ç‰©çš„å¤ä¹¦ã€‚",
  "test_scenarios": ["scenario_bargain", "scenario_ancient_knowledge"]
}
```

### 2. æ–°å¢æµ‹è¯•åœºæ™¯ (Add Scenario)

åªéœ€ä¿®æ”¹ `src/data/scenarios.json` æ–‡ä»¶å³å¯å®šä¹‰æ–°çš„æµ‹è¯•ç›®æ ‡å’Œæ¨¡æ‹Ÿç©å®¶è¡Œä¸ºã€‚

**å…³é”®å­—æ®µè¯´æ˜**ï¼š
*   `simulator_config`: å®šä¹‰æ¨¡æ‹Ÿç©å®¶ï¼ˆPlayer Agentï¼‰çš„äººè®¾å’Œç›®æ ‡ã€‚
*   `expected_tools`: ï¼ˆå¯é€‰ï¼‰å®šä¹‰åœ¨è¯¥åœºæ™¯ä¸­**é¢„æœŸ NPC åº”è¯¥è°ƒç”¨**çš„å·¥å…·åˆ—è¡¨ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦è°ƒç”¨ï¼Œå¹¶æ®æ­¤è®¡ç®—é€šè¿‡ç‡ã€‚

**ç¤ºä¾‹**ï¼šæ·»åŠ ä¸€ä¸ªâ€œè°œé¢˜ç ´è§£æµ‹è¯•â€
```json
{
  "id": "scenario_riddle_solving",
  "name": "è°œé¢˜ç ´è§£æµ‹è¯•",
  "description": "æµ‹è¯•NPCæ˜¯å¦èƒ½æå‡ºæœ‰éš¾åº¦çš„è°œé¢˜ï¼Œå¹¶åœ¨ç©å®¶ç­”å¯¹æ—¶ç»™äºˆå¥–åŠ±æˆ–è®¤å¯ã€‚",
  "expected_tools": [],
  "simulator_config": {
    "name": "èªæ˜çš„å†’é™©è€…",
    "context": "ä½ æ˜¯ä¸€ä¸ªå–œæ¬¢æŒ‘æˆ˜æ™ºåŠ›çš„å†’é™©è€…ã€‚",
    "goal": "è¯·æ±‚NPCå‡ºä¸€ä¸ªè°œé¢˜ã€‚å°è¯•è§£å¼€å®ƒï¼ˆæˆ–è€…å‡è£…è§£ä¸å¼€æ±‚æç¤ºï¼‰ã€‚è§‚å¯ŸNPCçš„å‡ºé¢˜æ°´å¹³å’Œäº’åŠ¨ååº”ã€‚"
  },
  "max_turns": 4
}
```

### 3. æ–°å¢å·¥å…· (Add Tool)

è¦è®© NPC æ‹¥æœ‰æ–°èƒ½åŠ›ï¼ˆå¦‚æŸ¥é˜…æ•°æ®åº“ã€å‘æ”¾ç‰©å“ï¼‰ï¼Œéœ€è¦ä¿®æ”¹ Python ä»£ç å’Œé…ç½®ã€‚

**æ­¥éª¤ 1ï¼šå®ç°å·¥å…·é€»è¾‘**
åœ¨ `src/agents/npc.py` ä¸­çš„ `MockNPC` ç±»é‡Œï¼š
1.  åœ¨ `self.tools` åˆ—è¡¨ä¸­å®šä¹‰å·¥å…·çš„ Schemaï¼ˆJSON Schemaï¼‰ã€‚
2.  å®ç°å¯¹åº”çš„ Python æ–¹æ³•ã€‚
3.  åœ¨ `chat` å’Œ `chat_with_stats` æ–¹æ³•çš„å·¥å…·å¤„ç†å¾ªç¯ä¸­æ·»åŠ è°ƒç”¨é€»è¾‘ã€‚

**ä»£ç ç¤ºä¾‹** (`src/agents/npc.py`)ï¼š
```python
# 1. å®šä¹‰ Schema
self.tools = [
    {
        "type": "function",
        "function": {
            "name": "consult_ancient_tome",
            "description": "Consult the ancient tome for knowledge...",
            "parameters": { ... }
        }
    }
]

# 2. å®ç°æ–¹æ³•
def consult_ancient_tome(self, topic: str) -> str:
    # æ¨¡æ‹ŸæŸ¥é˜…çŸ¥è¯†åº“
    knowledge = self.knowledge_base.get(topic, "æœªçŸ¥")
    return knowledge

# 3. å¤„ç†è°ƒç”¨ (åœ¨ chat/chat_with_stats æ–¹æ³•ä¸­)
if tool_call.function.name == "consult_ancient_tome":
    # è§£æå‚æ•°å¹¶è°ƒç”¨
    args = json.loads(tool_call.function.arguments)
    result = self.consult_ancient_tome(args.get("topic"))
    # æ·»åŠ åˆ°å†å²è®°å½•...
```

**æ­¥éª¤ 2ï¼šé…ç½®æµ‹è¯•åœºæ™¯**
åœ¨ `src/data/scenarios.json` ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°åœºæ™¯å¹¶åœ¨ `expected_tools` å­—æ®µä¸­åŠ å…¥è¯¥å·¥å…·åç§°ï¼Œä»¥éªŒè¯ NPC æ˜¯å¦èƒ½æ­£ç¡®ä½¿ç”¨å®ƒã€‚

### 4. é…ç½®è¯„æµ‹æ ‡å‡†

ä¿®æ”¹ `src/data/grader_config.json` å¯ä»¥è‡ªå®šä¹‰è¯„æµ‹ç»´åº¦å’Œä½¿ç”¨çš„è£åˆ¤æ¨¡å‹ï¼š

```json
{
  "default_model": "qwen-plus", // é»˜è®¤è£åˆ¤æ¨¡å‹
  "criteria": {
    "role_consistency": {
      "description": "è§’è‰²ä¸€è‡´æ€§...",
      "model": "qwen-max",      // é’ˆå¯¹è¯¥ç»´åº¦çš„ç‰¹å®šæ¨¡å‹ï¼ˆè¦†ç›–é»˜è®¤æ¨¡å‹ï¼‰
      "enabled": true
    }
  }
}
```

## è¯„æµ‹æŠ¥å‘Šç¤ºä¾‹

```json
{
  "npc_name": "æ ¼ç½—å§†",
  "scenario_name": "ç ä»·æµ‹è¯•",
  "metrics": {
    "avg_latency_seconds": 1.2,
    "avg_tokens_per_turn": 45.5,
    "total_tokens": 520
  },
  "evaluations": {
    "role_consistency": {
      "score": 5,
      "reasoning": "NPCé¢å¯¹ç©å®¶çš„æ— ç†ç ä»·è¡¨ç°å‡ºäº†æå¤§æ„¤æ€’ï¼Œç¬¦åˆæš´èºé“åŒ çš„äººè®¾ã€‚",
      "evidence": "NPC: 'ä¸‰æŠ˜ï¼Ÿä½ è¿™å£æ°”æ¯”ç‚‰æ¸£è¿˜è´±ï¼'"
    }
  }
}
```
